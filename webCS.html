<html>
<head>
<script src='./js/jquery-3.5.1.min.js'></script>
<script src='./js/jquery-ui.min.js'></script>
<script src='./js/webcs.js'></script>
<script src='./js/highlight.min.js'></script>
<link rel='stylesheet' href='./css/jquery-ui.min.css' />
<link rel='stylesheet' href='./css/highlight.min.css' />
<style>
.ui-menu { width: 150px; }
#menus .top-menu {
    display:inline;
    float:left;
}
#menus .top-menu-right {
    display:inline;
    float:right;
}
#display0{
    margin-top:40px;
    display:block;
    position:absolute;
}
#image000{
    margin:0;
}
#messagebox{
    background: gray;
    color:white;
}
.stdsize{
    width:640px;
    height:480px;
    display:inline;
}
.cssize{
    width:512px;
    height:512px;
    display:inline;
}
.fullsize{
    width:100%;
    height:100%;
}
#display1{
    margin:80 40 0 0;
    padding:0 80 0 0;
    display:block;
    position:absolute;
    background: black;
    color:white;
}
.code{
    background: black;
    color:white;
}
xmp.code{
    margin:10 40 0 40;
    background: white;
    color:blue;
}
.minimize{
width:10;
height:10;
text-overflow:ellipsis; overflow:hidden; 
}
</style>
</head>
<body>

<div id='body'>
    <div id='menus'>
        <div class='top-menu' style='display:inline'>
            <ul id='filemenu'>
                <li> <div>file</div>
                <ul>
                    <li>
                        <div id='loadimg'> Open </div>
                        <input id='loadlocal' type='file' style='display:none'> </input>
                    </li>

                    <li class='ui-state-disabled'><div>Close</div></li>
                </ul>
                </li>
            </ul>
        </div>
        <div class='top-menu' style='display:none'>
            <ul id='viewmenu'>
                <li> <div>view</div>
                    <ul id='view_menus'>
                    <li data-filter='full' cmd=0><div>full size</div></li>
                    <li data-filter='640x480' cmd=1><div>640x480</div></li>
                    <li data-filter='512x512' cmd=1><div>512x512</div></li>
                    </ul>
                </li>
            </ul>
        </div>
        <div class='top-menu'>
            <ul id='examplemenu'>
                <li> <div>example</div>
                    <ul id='example_menus'>
                        <!-- 
                            <li data-filter='grayscale'><div>grayscale</div></li> 
                        -->
                    </ul>
                </li>
            </ul>
        </div>
        <div class='top-menu' style='margin-left:200'>
            <div id='messageboxdiv'>
            <label id="messagebox" class='ui-corner-all'></label>
            </div>
        </div>
        <div class='top-menu-right' >
            <div id='github'> <a href='https://github.com/zhenghuadai/webcs' target="_blank">
<svg height="32" class="octicon octicon-mark-github text-white" viewBox="0 0 16 16" version="1.1" width="32" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
              </a>
           </div>
        </div>
        <div class='top-menu-right' style='display:none'>
            <label for="AddonToggleButton" title='Use last output as input'>Add On</label>
            <input type="checkbox" id="AddonToggleButton" />
        </div>
        <div class='top-menu-right' >
            <label for="GPUToggleButton">GPU</label>
            <input type="checkbox" id="GPUToggleButton" checked/>
        </div>
        <div class='top-menu-right' >
            <div id='timediv'> <label id="time">0</label> ms </div>
        </div>
        <!-- 
        <div class='top-menu-right' >
            <div id='TestGPU'> <label >Test</label> </div>
        </div>
        -->

    </div>
    <div id='thumb'>
    </div>
    <div id='display1' style='display:block'>
        <div id='code_div'>
            <xmp width="100%" class='code'>
              <script src='http://zhenghuadai.github.io/js/webcs.js'></script>               
            </xmp>
            <pre id='codes_block' class="prettyprint">
              <!--
              <code id='code_smm_naive' class='code example language-javascript'></code>
              -->
            </pre>
        </div>
        <div id='canvas_div'>
          <canvas id='canvas2GPU' class='canvas display1' title0='GPU Canvas' width=512 height=512></canvas>
        </div>
    </div>
    <div id='display0' style='display:none'>
        <img id='image000' class='image display0 cssize' src='images/lenna.png' title0='Source Image' style='display:block'/>
        <canvas id='canvasimg0' class='image display0' style='display:block'></canvas>
    </div>
    <script>

    let webCS = null;
    let cs_smm_naive = null;
    let cs_texture = null;
    let cs_texture2 = null;
    let cs_kernels = {};
    let glsl_kernels = {};
    let App = {};
    var X = 512, Y = 512, Z = 1;
    (function(){
        let testcases = [
                'smm_naive', 'texture', 'texture2', 'img_texture'
        ];
        // clang-format off
        function glsl_smm_naive(A,B,C){
                return `
                    // C[M, N] = A[M, K] * B[K, N]
                    uint M = this.uniform.MNK.x, N = this.uniform.MNK.y, K = this.uniform.MNK.z;
                    // Compute a single element C[thread.y, thread.x] by looping over k
                    float sum = 0.0;
                    for (uint k = 0u; k < K; k++)
                    {
                        sum += A[thread.y * K + k] * B[k * N + thread.x];
                    }
             
                    // Store the result
                    C[thread.y*N + thread.x] = sum;
                `;
            }

        function glsl_texture2(src, dst){
                return `
                ivec2 pos = ivec2(thread.xy);
                vec4 pixel = src[pos]; // vec4 pixel = imageLoad(src, pos);
                vec4 invert = vec4(1.0 - pixel.x, 1.0 - pixel.y, 1.0 - pixel.z, 1.0);
                dst[pos] = invert;     // imageStore(dst, pos, invert);
                `;
            }
        function glsl_texture(dst){
                return `
                ivec2 pos = ivec2(thread.xy);
                float x = float(thread.x);
                float y = float(thread.y);
                imageStore(dst, pos, vec4(x / (y+1.0+x), y / (y+1.0+x),  0.0, 1.0));
                `;
            }
        // clang-format on
        glsl_kernels.smm_naive = glsl_smm_naive;
        glsl_kernels.texture     = glsl_texture;
        glsl_kernels.texture2    = glsl_texture2;
        glsl_kernels.img_texture    = glsl_texture2;

    // menus for example 
    (function() {

        // append menus
        (function appendmenu() {
            function doone(thefilters, themenu) {
                let ula = $('<ul/>');
                thefilters.forEach(function(ele) {
                    ula.append(
                        '<li data-filter=\'' + ele + '\'><div>' + ele +
                        '</div></li>');
                });
                $(themenu).append(ula.children().detach());
            }
            doone(testcases, '#example_menus');
        })();
        var do_cs = {
        do_smm_naive:function (){
            var M = 64, N = 64, K = 64;
            var createArray= function ( n) { 
                var buf = new Float32Array(n);
                for(var i = 0; i < n; i++){
                    buf[i] = Math.random();
                }
                return buf;
            };
            let cpuA = createArray(M*K);
            let cpuB = createArray(K*N);
            let cpuC = createArray(M*N);
            if(cs_smm_naive == null){
                cs_smm_naive = webCS.createShader(glsl_smm_naive, { local_size:[8, 8, 1], groups:[M/8, N/8, 1]});
            }

            const t0 = performance.now();
            //cs_smm_naive.setUniform('MNK', M, N, K, 0).run(cpuA, cpuB, cpuC);
            cs_smm_naive.run(cpuA, cpuB, cpuC, {'MNK':[M,N,K,0]});
            const t1 = performance.now();
            t = t1 - t0;
            $('#time').html(t.toFixed(1).toString());
            if(true){
                let acc = 0, x = Math.floor(N*Math.random()),  y = Math.floor(N*Math.random());
                for(let k=0; k<K; k++) acc += cpuA[y*K + k] * cpuB[k*N + x]
                cs_smm_naive.getData('C', cpuC);
                let result = cpuC[y*N+x];
                let diff = result - acc;
                result = result.toFixed(7);
                diff = diff.toFixed(7);
                App.showMessage(`Cgpu[${y},${x}] = ${result}; \u2003<br/> Cgpu[${y},${x}] - Ccpu[${y},${x}] : ${diff}`);
            }
            $("#code_smm_naive").show();

        },
        do_texture:function(){
                //ivec2 storePos = ivec2(gl_GlobalInvocationID.xy);
                //imageStore(dst, storePos, vec4(vec2(gl_WorkGroupID.xy) / vec2(gl_NumWorkGroups.xy), 0.0, 1.0));
            if(cs_texture == null){
                cs_texture = webCS.createShader(glsl_texture, { local_size:[8, 8, 1], groups:[X/8, Y/8, 1], params:{'dst':'texture'}});
            }

            cs_texture.run(null);

            let tex = cs_texture.getTexture('dst');
            webCS.present(tex);
            $("#display1")[0].appendChild(webCS.canvas);
            $("#canvas2GPU").show();
        },

        do_texture2: function(){
            do_cs.do_texture();
            if(cs_texture2 == null){
                cs_texture2 = webCS.createShader(glsl_texture2, { local_size:[8, 8, 1], groups:[X/8, Y/8, 1], params:{src:'texture', 'dst':'texture'}});
            }

            let texSrc = cs_texture.getTexture('dst');
            cs_texture2.run(texSrc, null);

            let tex = cs_texture2.getTexture('dst');
            webCS.present(tex);
            $("#display1")[0].appendChild(webCS.canvas);
            $("#canvas2GPU").show();
        },

        do_img_texture: function(){
            if(cs_texture2 == null){
                cs_texture2 = webCS.createShader(glsl_texture2, { local_size:[8, 8, 1], groups:[X/8, Y/8, 1], params:{src:'texture', 'dst':'texture'}});
            }

            let texSrc = $('#image000')[0];
            cs_texture2.run(texSrc, null);

            let tex = cs_texture2.getTexture('dst');
            webCS.present(tex);
            $("#display1")[0].appendChild(webCS.canvas);
            $("#canvas2GPU").show();
        }
		};
        function doExampleGPU(e, ui) {
            let myfilter = ui.item.attr('data-filter');
            $(".code.example").hide();
            $("#canvas2GPU").hide();
            $("#code_"+myfilter).show();
            do_cs["do_" + myfilter]();
        }
        function doExample(e, ui) {
            let myfilter = ui.item.attr('data-filter');
            if(webCS == null){
                webCS = new WebCS({canvas:$("#canvas2GPU")[0]});
                //webCS = new WebCS();
            }
            if(myfilter == null){
                return;
            }
            if ($('#GPUToggleButton').is(':checked')) {
                doExampleGPU(e, ui);
            } else {
            }
        }
        $('#examplemenu').menu({select: doExample});

    })();
        
    (function setupExample(){
        let example_js= {}
            // clang-format off
        example_js.smm_naive = `

        let M = 64, N = 64, K =64;
        var createArray = function ( n) { 
            var buf = new Float32Array(n);
            for(var i = 0; i < n; i++){buf[i] = Math.random();}
            return buf;
        };
        let cpuA = createArray(M*K);
        let cpuB = createArray(K*N);
        let cpuC = createArray(M*N);
        let webCS = new WebCS();
        let cs_smm = webCS.createShader(glsl_smm_naive, {local_size:[8, 8, 1], groups:[M/8, N/8, 1]});
        cs_smm.setUniform('MNK', M, N, K, 0).run(cpuA, cpuB, cpuC);
        // or
        // cs_smm_naive.run(cpuA, cpuB, cpuC, {'MNK':[M,N,K,0]});
        cs_smm.getData('C', cpuC);
            `;
        // clang-format on
        example_js.texture = `

        var X = 512, Y = 512, Z = 1;
        let webCS = new WebCS({width:X, height:Y});
        // or let webCS = new WebCS({canvas:$("#canvas2GPU")[0]});
        let cs_texture = webCS.createShader(glsl_texture, { local_size:[8, 8, 1], groups:[X/8, Y/8, 1], params:{'dst':'texture'}});

        cs_texture.run(null);

        let tex = cs_texture.getTexture('dst');
        webCS.present(tex);
        $("#display1")[0].appendChild(webCS.canvas);
        `;
        example_js.texture2 = `

        cs_texture().run(null); // to gerenate a texture
        var X = 512, Y = 512, Z = 1;
        let webCS = new WebCS({width:X, height:Y});
        // or let webCS = new WebCS({canvas:$("#canvas2GPU")[0]});
        let cs_texture2 = webCS.createShader(glsl_texture2, { local_size:[8, 8, 1], groups:[X/8, Y/8, 1], params:{src:'texture', 'dst':'texture'}});

        let texSrc = cs_texture.getTexture('dst');
        cs_texture2.run(texSrc, null);

        let tex = cs_texture2.getTexture('dst');
        webCS.present(tex);
        $("#display1")[0].appendChild(webCS.canvas);
        `;
        example_js.img_texture= `

        var X = 512, Y = 512, Z = 1;
        let webCS = new WebCS({width:X, height:Y});
        // or let webCS = new WebCS({canvas:$("#canvas2GPU")[0]});
        let cs_texture2 = webCS.createShader(glsl_texture2, { local_size:[8, 8, 1], groups:[X/8, Y/8, 1], params:{src:'texture', 'dst':'texture'}});

        let texSrc = $('#image000')[0];
        cs_texture2.run(texSrc, null);

        let tex = cs_texture2.getTexture('dst');
        webCS.present(tex);
        $("#display1")[0].appendChild(webCS.canvas);
        `;
        //$("#code_smm_naive").hide();
        let codes_block = $('#codes_block');
        testcases.forEach(function(ele) {
            let code_ele = $(`<code id='code_${ele}' class='code example language-javascript'></code>`)
            let btf = hljs.highlight('c++', glsl_kernels[ele].toString());
            let btf2 = hljs.highlight('javascript', example_js[ele]);
            code_ele.html( btf.value + btf2.value.replace('glsl_'+ele, '<span class="hljs-title">glsl_'+ ele +'</span>'));
            codes_block.append(code_ele);
        });
        $(".code.example").hide();
        $("#code_smm_naive").show();
    })();
        

    })();
    </script>
<script src='./js/webCS.html.js'></script>
</div>
</body>
</html>
