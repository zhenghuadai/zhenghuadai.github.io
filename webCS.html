<html>
<head>
<script src='./js/jquery-3.5.1.min.js'></script>
<script src='./js/jquery-ui.min.js'></script>
<script src='./js/webcs.js'></script>
<script src='./js/highlight.min.js'></script>
<link rel='stylesheet' href='./css/jquery-ui.min.css' />
<link rel='stylesheet' href='./css/highlight.min.css' />
<style>
.ui-menu { width: 150px; }
#menus .top-menu {
    display:inline;
    float:left;
}
#menus .top-menu-right {
    display:inline;
    float:right;
}
#display0{
    margin-top:40px;
    display:block;
    position:absolute;
}
#image000{
    margin:0;
}
#messagebox{
    background: gray;
    color:white;
}
.stdsize{
    width:640px;
    height:480px;
    display:inline;
}
.fullsize{
    width:100%;
    height:100%;
}
#display1{
    margin:80 40 0 0;
    padding:0 80 0 0;
    display:block;
    position:absolute;
    background: black;
    color:white;
}
.code{
    background: black;
    color:white;
}
xmp.code{
    margin:10 40 0 40;
    background: white;
    color:blue;
}
.minimize{
width:10;
height:10;
text-overflow:ellipsis; overflow:hidden; 
}
</style>
</head>
<body>

<div id='body'>
    <div id='menus'>
        <div class='top-menu' style='display:none'>
            <ul id='filemenu'>
                <li> <div>file</div>
                <ul>
                    <li>
                        <div id='loadimg'> Open </div>
                        <input id='loadlocal' type='file' style='display:none'> </input>
                    </li>

                    <li class='ui-state-disabled'><div>Close</div></li>
                </ul>
                </li>
            </ul>
        </div>
        <div class='top-menu' style='display:none'>
            <ul id='viewmenu'>
                <li> <div>view</div>
                    <ul id='view_menus'>
                    <li data-filter='full' cmd=0><div>full size</div></li>
                    <li data-filter='640x480' cmd=1><div>640x480</div></li>
                    </ul>
                </li>
            </ul>
        </div>
        <div class='top-menu'>
            <ul id='examplemenu'>
                <li> <div>example</div>
                    <ul id='example_menus'>
                        <!-- 
                            <li data-filter='grayscale'><div>grayscale</div></li> 
                        -->
                    </ul>
                </li>
            </ul>
        </div>
        <div class='top-menu' style='margin-left:200'>
            <div id='messageboxdiv'>
            <label id="messagebox" class='ui-corner-all'></label>
            </div>
        </div>
        <div class='top-menu-right' >
            <div id='github'> <a href='https://github.com/zhenghuadai/webcs' target="_blank">
<svg height="32" class="octicon octicon-mark-github text-white" viewBox="0 0 16 16" version="1.1" width="32" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
              </a>
           </div>
        </div>
        <div class='top-menu-right' style='display:none'>
            <label for="AddonToggleButton" title='Use last output as input'>Add On</label>
            <input type="checkbox" id="AddonToggleButton" />
        </div>
        <div class='top-menu-right' >
            <label for="GPUToggleButton">GPU</label>
            <input type="checkbox" id="GPUToggleButton" checked/>
        </div>
        <div class='top-menu-right' >
            <div id='timediv'> <label id="time">0</label> ms </div>
        </div>
        <!-- 
        <div class='top-menu-right' >
            <div id='TestGPU'> <label >Test</label> </div>
        </div>
        -->

    </div>
    <div id='thumb'>
    </div>
    <div id='display0' style='display:none'>
        <img id='image000' class='image display1' src='images/lenna.png' title0='Source Image'/>
        <canvas id='canvasimg0' class='image display1' style='display:none'></canvas>
        <canvas id='canvasCPU' class='canvas display1' title0='CPU Canvas'></canvas>
        <canvas id='canvasGPU' class='canvas display1' title0='GPU Canvas'></canvas>
    </div>
    <div id='display1' style='display:block'>
        <xmp width="100%" class='code'>
               <script src='http://zhenghuadai.github.io/js/webcs.js'></script>               
        </xmp>
        <pre class="prettyprint">
        <code id='code0' class='code language-javascript'></code>
        </pre>
    </div>
    <script>

    (function(){
    let webCS = null;
    let cs_sgemm_naive = null;
    // file menu
    (function() {
        $('#loadimg').click(function() {
            $('#loadlocal').click();
        });
        $('#loadlocal').on('change', function(ev) {
            let input = ev.target;
            if (input.files && input.files[0]) {
                var reader = new FileReader();

                reader.onload = function(e) {
                    $('#image000').attr('src', e.target.result);
                };

                reader.readAsDataURL(input.files[0]);
            }
        });
        $('#filemenu').menu();
    })();


    // view menu
    $('#viewmenu').menu({
        select: function(e, ui) {
            let cmd = ui.item.attr('cmd');
            if (cmd == 0) {
            } else if (cmd == 1) {
            }
            if (cmd != undefined) {
            }
        }
    });

    function sgemmv1(A,B,C){
            return `
                // C[M, N] = A[M, K] * B[K, N]
                uint M = this.uniform.MNK.x, N = this.uniform.MNK.y, K = this.uniform.MNK.z;
                // Compute a single element C[thread.y, thread.x] by looping over k
                float sum = 0.0;
                for (uint k = 0u; k < K; k++)
                {
                    sum += A[thread.y * K + k] * B[k * N + thread.x];
                }
         
                // Store the result
                C[thread.y*N + thread.x] = sum;
            `;
        }
    // menus for example 
    (function() {

        // append menus
        (function appendmenu() {
            let filters = [
                'sgemm_naive'
            ];
            function doone(thefilters, themenu) {
                let ula = $('<ul/>');
                thefilters.forEach(function(ele) {
                    ula.append(
                        '<li data-filter=\'' + ele + '\'><div>' + ele +
                        '</div></li>');
                });
                $(themenu).append(ula.children().detach());
            }
            doone(filters, '#example_menus');
        })();
        function do_sgemm_naive(){
            var M = 64, N = 64, K = 64;
            var createArray= function ( n) { 
                var buf = new Float32Array(n);
                for(var i = 0; i < n; i++){
                    buf[i] = Math.random();
                }
                return buf;
            };
            let cpuA = createArray(M*K);
            let cpuB = createArray(K*N);
            let cpuC = createArray(M*N);
            if(cs_sgemm_naive == null){
                cs_sgemm_naive = webCS.createShader(sgemmv1, { local_size:[8, 8, 1], groups:[M/8, N/8, 1]});
            }

            const t0 = performance.now();
            cs_sgemm_naive.setUniform('MNK', M, N, K, 0).run(cpuA, cpuB, cpuC);
            const t1 = performance.now();
            t = t1 - t0;
            $('#time').html(t.toFixed(1).toString());
            if(true){
                let acc = 0, x = Math.floor(N*Math.random()),  y = Math.floor(N*Math.random());
                for(let k=0; k<K; k++) acc += cpuA[y*K + k] * cpuB[k*N + x]
                cs_sgemm_naive.getData('C', cpuC);
                let result = cpuC[y*N+x];
                let diff = result - acc;
                result = result.toFixed(7);
                diff = diff.toFixed(7);
                showMessage(`Cgpu[${y},${x}] = ${result}; \u2003<br/> Cgpu[${y},${x}] - Ccpu[${y},${x}] : ${diff}`);
            }
            $("#code0").show();

        }
        function doExampleGPU(e, ui) {
            let myfilter = ui.item.attr('data-filter');
            console.log(myfilter);
            if(myfilter == 'sgemm_naive'){
                do_sgemm_naive();
            }
        }
        
        function setupExample(){
            {
                let btf = hljs.highlight('c++', sgemmv1.toString());
                let example_js = `

        let M = 64, N = 64, K =64;
        var createArray = function ( n) { 
            var buf = new Float32Array(n);
            for(var i = 0; i < n; i++){buf[i] = Math.random();}
            return buf;
        };
        let cpuA = createArray(M*K);
        let cpuB = createArray(K*N);
        let cpuC = createArray(M*N);
        let webCS = new WebCS();
        let cs_sgemm = webCS.createShader(sgemmv1, {local_size:[8, 8, 1], groups:[M/8, N/8, 1]});
        cs_sgemm.setUniform('MNK', M, N, K, 0).run(cpuA, cpuB, cpuC);
        cs_sgemm.getData('C', cpuC);
                `;
                let btf2 = hljs.highlight('javascript', example_js);
                $("#code0").html( btf.value + btf2.value.replace('sgemmv1', '<span class="hljs-title">sgemmv1</span>'));
            }
            //$("#code0").hide();
        }
        setupExample();
        
        function doExample(e, ui) {
            let myfilter = ui.item.attr('data-filter');
            if(webCS == null){
                webCS = new WebCS();
            }
            if(myfilter == null){
                return;
            }
            if ($('#GPUToggleButton').is(':checked')) {
                doExampleGPU(e, ui);
            } else {
            }
        }
        $('#examplemenu').menu({select: doExample});
    })();

    // right buttons
    (function() {
        $('#AddonToggleButton').button();
        $('#GPUToggleButton').button();
        $('#timediv').button();
        $('#TestGPU').button();
    })();

    // message box
    function showMessage(txt) {
        $('#messagebox').html(txt);
        $('#messagebox').show();
        if (txt && txt.length > 0) {
			$('#messagebox').removeClass('minimize');
            $('#messagebox').addClass('ui-tooltip');
        } else {
            $('#messagebox').removeClass('ui-tooltip');
        }
        setTimeout(function(){$('#messagebox').addClass('minimize');}, 5000);
    };
	$('#messagebox').hover(
            function() {
				$('#messagebox').removeClass('minimize');
            },
            function() {
				setTimeout(function(){$('#messagebox').addClass('minimize');}, 2000);
            });

    $('#meesagebox').button();
    })();
    </script>
</div>
</body>
</html>
