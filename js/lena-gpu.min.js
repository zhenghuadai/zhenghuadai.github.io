(function(a){var d=Math.atan2;function b(a){let b=i[a];return function(a,c){return this.convolution(a,b,c)}}function c(a){return function(b,c){return this.opsImage(a,b,c,b.width,b.height)}}var e={filterDataFunc:function(c,d,e){for(var f=0,h=0,k=0,l=1,a=this.constants.fw,m=this.constants.fh,n=this.constants.fw2,o=this.constants.fh2,p=0;p<m;p++)for(var q,s=0;s<a;s++)q=4*((this.thread.y-o+p)*e+(this.thread.x-n+s)),f+=c[q+0]*d[p*a+s],h+=c[q+1]*d[p*a+s],k+=c[q+2]*d[p*a+s];return exports(f,h,k,l)},filterFunc:function(c,d){for(var e=0,f=0,h=0,k=1,a=this.constants.fw,l=this.constants.fh,m=this.constants.fw2,n=this.constants.fh2,o=0;o<l;o++)for(var p=0;p<a;p++){const b=c[this.thread.y-n+o][this.thread.x-m+p];e+=b[0]*d[o*a+p],f+=b[1]*d[o*a+p],h+=b[2]*d[o*a+p]}return exports(e,f,h,k)}},g={gray:function(d){var e=d[this.thread.y][this.thread.x],f=e[0],h=e[1],g=e[2],b=e[3],a=.2126*f+.7152*h+.0722*g;return exports(a,a,a,1)},thresholding:function(c,d,e){var f=c[this.thread.y][this.thread.x],h=f[0],i=f[1],j=f[2],k=f[3],a=.2126*h+.7152*i+.0722*j;return a>d&&a<e||(h=i=j=0),exports(h,i,j,1)},thresholding2:function(c,d,e){var f=c[this.thread.y][this.thread.x],h=f[0],i=f[1],j=f[2],k=f[3],a=.2126*h+.7152*i+.0722*j;return h=a>d&&a<e?i=j=1:i=j=0,exports(h,i,j,1)},invert:function(a){var c=a[this.thread.y][this.thread.x],d=1-c[0],e=1-c[1],f=1-c[2];return exports(d,e,f,1)},red:function(a){var b=a[this.thread.y][this.thread.x];return exports(b[0],0,0,1)},green:function(a){var b=a[this.thread.y][this.thread.x];return exports(0,b[1],0,1)},blue:function(a){var b=a[this.thread.y][this.thread.x];return exports(0,0,b[2],1)},saturation:function(a,c){var d=a[this.thread.y][this.thread.x],e=.3086,f=.6084,h=.082,i=((1-c)*e+c)*d[0]+(1-c)*f*d[1]+(1-c)*h*d[2],j=(1-c)*e*d[0]+((1-c)*f+c)*d[1]+(1-c)*h*d[2],g=(1-c)*e*d[0]+(1-c)*f*d[1]+((1-c)*h+c)*d[2];return exports(i,j,g,1)},sepia:function(c){var d=c[this.thread.y][this.thread.x],e=d[0],f=d[1],g=d[2],b=d[3],a=.3*e+.59*f+.11*g;return exports(a+40/255,a+20/255,a-20/255,1)},mirror:function(a,b){var c=a[this.thread.y][b-this.thread.x];return exports(c[0],c[1],c[2],1)},flip:function(a,b,c){var d=a[c-this.thread.y][this.thread.x];return exports(d[0],d[1],d[2],1)},passthrough:function(a){var b=a[this.thread.y][this.thread.x];return exports(b[0],b[1],b[2],1)}};cfunc={gradient:function(a){var c=Math.sqrt;function b(a,b,c,d,e,f){return a*d+b*e+c*f}var e=this.thread.x,f=this.thread.y;const g=a[f-1+0][e-1+0],h=a[f-1+0][e-1+1],i=a[f-1+0][e-1+2],j=a[f-1+1][e-1+0],k=a[f-1+1][e-1+1],l=a[f-1+1][e-1+2],m=a[f-1+2][e-1+0],n=a[f-1+2][e-1+1],o=a[f-1+2][e-1+2];var p=0,q=0;q=b(g[0],h[0],i[0],1/4,2/4,1/4)+b(m[0],n[0],o[0],-1/4,-2/4,-1/4),p=b(g[0],j[0],m[0],1/4,2/4,1/4)+b(i[0],l[0],o[0],-1/4,-2/4,-1/4);var r=0,s=0;return r=c(p*p+q*q),s=d(q,p),exports(r,s,0,1)},nonMaximumSuppression:function(a,b){for(var c=this.thread.x,e=this.thread.y,f=a[e][c],g=f[0],h=0;h<5;h++)for(var k=0;k<5;k++){const f=a[e-2+h][c-2+k],i=b[e-2+h][c-2+h],j=f[0],m=i[1];var l=d(h-2,k-2);const n=j*Math.abs(Math.cos(m-l));n>g&&(g=0)}return exports(2*g,2*g,2*g,1)}};var i={gaussian:[1/16,2/16,1/16,2/16,4/16,2/16,1/16,2/16,1/16],bigGaussian:[2/159,4/159,5/159,4/159,2/159,4/159,9/159,12/159,9/159,4/159,5/159,12/159,15/159,12/159,5/159,4/159,9/159,12/159,9/159,4/159,2/159,4/159,5/159,4/159,2/159],highpass:[-1,-1,-1,-1,8,-1,-1,-1,-1],laplacian:[0,-1,0,-1,4,-1,0,-1,0],lowpass3:[1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9],lowpass5:[1/25,1/25,1/25,1/25,1/25,1/25,1/25,1/25,1/25,1/25,1/25,1/25,1/25,1/25,1/25,1/25,1/25,1/25,1/25,1/25,1/25,1/25,1/25,1/25,1/25],prewittHorizontal:[1/3,1/3,1/3,0,0,0,-1/3,-1/3,-1/3],prewittVertical:[-1/3,0,1/3,-1/3,0,1/3,-1/3,0,1/3],roberts:[0,0,0,1,-1,0,0,0,0],sharpen:[0,-.2,0,-.2,1.8,-.2,0,-.2,0],sobelHorizontal:[1/4,2/4,1/4,0,0,0,-1/4,-2/4,-1/4],sobelVertical:[1/4,0,-1/4,2/4,0,-2/4,1/4,0,-1/4]};class j{constructor(a={}){this.width=a.width||null,this.height=a.height||null;var b=a.graphical||!0;this.gpu=a.gpu||new GPU,j.gpu=j.gpu||this.gpu,this.dynamicOutput=!(this.width&&this.height);let c={constants:{fw:3,fh:3,fw2:1,fh2:1},dynamicOutput:this.dynamicOutput,graphical:b},d={constants:{fw:5,fh:5,fw2:2,fh2:2},dynamicOutput:this.dynamicOutput,graphical:b},h={dynamicOutput:this.dynamicOutput,graphical:b},i={dynamicOutput:this.dynamicOutput,constants:{fw:3,fh:3,fw2:1,fh2:1}},l={dynamicOutput:this.dynamicOutput,constants:{fw:5,fh:5,fw2:2,fh2:2}};var m=[function(c,d,e,b){return this.color(c,d,e,b),0}],n=[function(c,d,e,b){return[c,d,e,b]}];for(var o in this.gfxkernels={},this.cskernels={},this.gfxkernels.conv3x3canvas=this.gpu.createKernel(e.filterDataFunc,c),this.gfxkernels.conv5x5canvas=this.gpu.createKernel(e.filterDataFunc,d),this.gfxkernels.conv3x3=this.gpu.createKernel(e.filterFunc,c),this.gfxkernels.conv5x5=this.gpu.createKernel(e.filterFunc,d),g)this.gfxkernels[o]=this.gpu.createKernel(g[o],h),this.cskernels[o]=this.gpu.createKernel(g[o],i);for(var o in cfunc)this.cskernels[o]=this.gpu.createKernel(cfunc[o],i);if(this.cskernels.conv5x5=this.gpu.createKernel(e.filterFunc,l),this.cskernels.conv3x3=this.gpu.createKernel(e.filterFunc,i),this.width&&this.height){let a=this.width,b=this.height;for(var p in this.gfxkernels)this.gfxkernels[p].setOutput([a,b]).setFunctions(m);for(var p in this.cskernels)this.cskernels[p].setOutput([a,b]),this.cskernels[p].setPipeline(!0).setFunctions(n)}else;}setOutput(a,b,c){this.dynamicOutput&&(a.setOutput([b,c]),a.canvas.width=b,a.canvas.height=c)}convolution(a,b,c){var d=this.gfxkernels.conv3x3;let e=a.width||this.width,f=a.height||this.height;if(null==b||null==e||null==f)return null;if(a.hasOwnProperty("data1d")&&Array.isArray(a.data1d)){let c=a.data1d;9==b.length?d=this.gfxkernels.conv3x3canvas:25==b.length&&(d=this.gfxkernels.conv5x5canvas),this.setOutput(d,e,f),d.data=d(c,b,e,f)}else 9==b.length?d=this.gfxkernels.conv3x3:25==b.length&&(d=this.gfxkernels.conv5x5),this.setOutput(d,e,f),d.data=d(a,b);return this.present(d,c,e,f),d}filterImage(a,b,c){let d=i[a];if(c){var e=c.getContext("2d"),f=c.getContext("webgl"),g=c.getContext("webgl2");console.log(e),console.log(f),console.log(g)}return this.convolution(b,d,c)}opsImage(a,b,c,...d){let e=b.width||this.width,f=b.height||this.height,g=a;return("string"==typeof a||a instanceof String)&&(g=this.gfxkernels[a]),this.setOutput(g,e,f),g.data=g.apply(null,[b].concat(d)),this.present(g,c,e,f),g}present(a,b,c,d){if(b&&b!=a.canvas){var e=b.getContext("2d");b.width=c,b.height=d,e.putImageData(new ImageData(a.getPixels(),c,d),0,0)}}saturation(a,b,c){return c=c||2.9,this.opsImage("saturation",a,b,c)}thresholding(a,b,c,d){return c=c||.25,d=d||.75,this.opsImage("thresholding",a,b,c,d)}canny(a,b,...c){let d=this.cskernels.gradient,e=a.width||this.width,f=a.height||this.height;var g=this.cskernels.gray(a,e,f),h=this.cskernels.conv5x5(g,i.bigGaussian),j=this.cskernels.gradient(h),k=this.cskernels.conv3x3(h,i.laplacian),l=this.cskernels.nonMaximumSuppression(k,j),m=this.cskernels.thresholding2(l,.02,.613);return this.gfxkernels.passthrough(m,e,f),this.present(this.gfxkernels.passthrough,b,e,f),this.gfxkernels.passthrough}}for(var k in i)j.prototype[k]=b(k);for(var l of[["grayscale","gray"],["invert"],["red"],["blue"],["green"],["sepia"],["mirror"],["flip"]]){let a=l[0],b=1==l.length?l[0]:l[1];j.prototype[a]=c(b)}a.LenaGPU=j})(window);